---
title: "Study of Global radiation enhancement over Thessaloniki"
author:
  - Natsis Athanasios^[Laboratory of Atmospheric Physics, AUTH, natsisthanasis@gmail.com]
  - Alkiviadis Bais^[Laboratory of Atmospheric Physics, AUTH.]
  - Charikleia Meleti^[Laboratory of Atmospheric Physics, AUTH.]
date: "`r format(Sys.time(), '%F')`"

documentclass: article
classoption:   a4paper,oneside
fontsize:      11pt
geometry:      "left=0.5in,right=0.5in,top=0.5in,bottom=0.5in"

bibliography:    [references.bib]
biblio-style:    apalike

header-includes:
- \usepackage{caption}
- \usepackage{placeins}
- \captionsetup{font=small}
- \usepackage{multicol}
- \setlength{\columnsep}{1cm}

output:
  bookdown::pdf_document2:
    number_sections:  no
    fig_caption:      no
    keep_tex:         no
    latex_engine:     xelatex
    toc:              yes
  html_document:
    keep_md:          yes
  odt_document:  default
  word_document: default

---

```{r include=FALSE, echo=FALSE}

####_  Document options _####

knitr::opts_chunk$set(echo       = FALSE   )
knitr::opts_chunk$set(cache      = TRUE    )
knitr::opts_chunk$set(include    = TRUE    )
knitr::opts_chunk$set(comment    = ""      )
# knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(dev        = "png"   )

knitr::opts_chunk$set(fig.width  = 8       )
knitr::opts_chunk$set(fig.height = 6       )

knitr::opts_chunk$set(out.width  = "60%"    )
knitr::opts_chunk$set(fig.align  = "center" )
# knitr::opts_chunk$set(fig.pos    = '!h'     )
```


## Abstract

Measurements of solar shortwave global horizontal irradiance (GHI) and direct normal irradiance (DNI) are performed simultaneously since 2016 in Thessaloniki, Greece, respectively with a CM-21 pyranometer and a CHP-1 pyrheliometer both by Kipp & Zonen. Here we identify and investigate the occurrence of enhancement events of GHI in relation to the visibility of the Sun as derived by the DNI measurements, the clearness index ($K_t = {GHI}_{MEASURED}/GHI_{MODEL}$), the solar zenith angle and the magnitude of the enhancement events. Simulations of GHI and DNI are derived by LibRadtran based on aerosol and water vapor measurements of a collocated Cimel sun-photometer. Moreover, we investigate the seasonal and long-term behavior of these events in relation to the above factors.

In addition, the time series of GHI and DNI for the period 2016-2019 is analyzed by an iterative optimization method, in order to tune the clear-sky detection algorithm of Reno et al. (2016) to the local conditions and to test a few simple global radiation models for obtaining a better match with the measurements conducted under cloud-free conditions. Based on these results the detection of enhancement events can be extended back to the start of the GHI record of Thessaloniki in the early 1990s. This backward extension will allow investigation of the long-term behavior of the enhancement events which may have been affected by changes in climate.



```{r include=F, echo=F}
####  Set environment  ####
rm(list = (ls()[ls() != ""]))
Sys.setenv(TZ = "UTC")
tic <- Sys.time()
Script.Name <- tryCatch({ funr::sys.script() },
                        error = function(e) { cat(paste("\nUnresolved script name: ", e),"\n\n")
                            return("Climatological_") })
if(!interactive()) {
    pdf(  file = paste0("~/MANUSCRIPTS/presentations/IRS2020_enhancement/runtime/",  basename(sub("\\.R$",".pdf", Script.Name))))
    sink( file = paste0("~/MANUSCRIPTS/presentations/IRS2020_enhancement/runtime/",  basename(sub("\\.R$",".out", Script.Name))), split=TRUE)
    filelock::lock(paste0("~/MANUSCRIPTS/presentations/IRS2020_enhancement/runtime/",basename(sub("\\.R$",".lock",Script.Name))),timeout = 0)
}


library(data.table)
# library(RAerosols)
# library(R.utils)

source("~/FUNCTIONS/R/data.R")
source("~/FUNCTIONS/R/trig_deg.R")


## load models
# load("/home/athan/Aerosols/source_R/Global_models.Rda")
load("./data/Combinations_results_2022-06-14_153313.Rds")


GLB_ench_THRES     <- 0    ## enchantment % relative to HAU
GLB_diff_THRES     <- 10   ## enchantment absolute diff to HAU
Clearness_Kt_THRES <- 0.8  ## enchantment threshold
wattGLB_THRES      <- 20   ## minimum value to consider
wattDIR_THRES      <- 20   ## minimum value to consider
min_elevation      <- 10   ## minimum sun elevation to use
ampl               <- 1.05 ## adjusted HAU amplified threshold
SZA_BIN            <- 1
```

## Introduction

Radiation clouds trends

## Data description


A radiation data quality assurance procedure was applied adjusted for the site,
based on methods of Long and Shi\ [-@long_automated_2008; -@Long2006].
Only data characterized with acceptable quality was used.


By the GHI and DNI for the period 2016 â€“ 2021 and using the iterative
method of optimizing the 'Clear sky' identification method, as proposed
by @Long2000 and @Reno2016. We were able to calibrate the above method
for our site. Among the eight simple models tested by @Reno2016, we found
the best result with an adjusted Haurwitz model (A-HAU), using as the main selector the
RMSE.




As enhancement cases of GHI we have chosen the following criteria, were all
conditions musth be met.

- Sun elevation angle above $`r min_elevation`^\circ$.
- GHI values above $`r ampl` \times \text{A-HAU} + `r GLB_diff_THRES`$
- Clearness index $k_t > `r Clearness_Kt_THRES`$

To establish some criteria for the GHI enhancement cases we use similar
criteria to ...........[@Vamvakas2020]


Also see Equation \@ref(eq:ahau).

\begin{equation}
\text{GHI} = `r signif(gather_results$alpha[gather_results$CS_models=="HAU"],digits = 3 )` \times 1098 \times \cos( \text{SZA} ) \times \exp \left( \frac{ - 0.057}{\cos(\text{SZA})} \right)  (\#eq:ahau)
\end{equation}


```{r }
##TODO HAU selection plot



HAU <- function( sza,
                 a = 1098,
                 b = 0.057 ) {
    GHI <- a * cosde( sza ) * exp( - b / cosde(sza) )
    GHI <- gather_results$alpha[gather_results$CS_models=="HAU"] * GHI
    return(GHI)
}


CSdt <- readRDS("./data/Clear_Sky.Rds")
suppressMessages( rm.cols.DT(CSdt, "CSflag_*") )

## keep only whole years
CSdt <- CSdt[ year(Date) >= 1994 & year(Date) <= 2021 ]

## only when sun is up
CSdt <- CSdt[ Elevat > min_elevation ]

## Quality Control data only
CSdt[ QCF_DIR != "good", wattDIR := NA ]
CSdt[ QCF_GLB != "good", wattGLB := NA ]
CSdt$QCF_DIR <- NULL
CSdt$QCF_GLB <- NULL


## use cs model
##  i) the GHI_MEASURED - MODELED to be higher than 5% (GHI_MEASURED-MODELED >= 5%)
CSdt[ , HAU    := HAU(SZA) * ampl ]
CSdt[ , defHAU := HAU(SZA) ]


##  i) clearness index to be lower or higher than 1 for the detection of non-extreme (Kt <= 1 ) and extreme enhancements cases (Kt > 1).




## some metrics
CSdt[ , GLB_diff :=   wattGLB - HAU ]         ## enhancement
CSdt[ , GLB_ench := ( wattGLB - HAU ) / HAU ] ## relative enhancement
CSdt[ , GLB_rati :=   wattGLB / HAU   ]

## select some days for display
enh_days <- CSdt[ GLB_ench     > GLB_ench_THRES      &
                  Clearness_Kt > Clearness_Kt_THRES  &
                  wattGLB      > wattGLB_THRES       &
                  GLB_diff     > GLB_diff_THRES,
                  .( Enh_sum      = sum(GLB_ench, na.rm = T),
                     Enh_max      = max(GLB_ench, na.rm = T),
                     Enh_diff_sum = sum(GLB_diff, na.rm = T),
                     Enh_diff_max = sum(GLB_diff, na.rm = T)) , Day ]


## interesting days first
setorder( enh_days, -Enh_sum )
setorder( enh_days, -Enh_max )
setorder( enh_days, -Enh_diff_sum )

## plot some interestin days
daylist <- enh_days$Day
daylist <- daylist[1:30]

## plot one selected day
daylist <- as.Date(c("2017-04-08"))




for ( aday in daylist ) {
    temp <- CSdt[ Day == aday ]

    par(mar=c(4,4,1,1))

    ylim = range(0, temp$TSIextEARTH_comb * cosde(temp$SZA), temp$wattGLB)

    plot(temp$Date, temp$wattGLB, "l", col = "green",
         ylim = ylim,
         ylab = expression(Watt/m^2), xlab = "UTC")

    lines(temp$Date, temp$wattHOR, col = "blue")

    lines(temp$Date, temp$TSIextEARTH_comb * cosde(temp$SZA))


    lines(temp$Date, temp$defHAU, col = "red" )

    # lines(temp$Date, temp$HAU + wattGLB_THRES , col = "red" )

    # lines(temp$Date, temp$CS_ref, col = "red" ,lty=3)

    # points(temp[ GLB_ench > GLB_ench_THRES, Date ], temp[ GLB_ench > GLB_ench_THRES, wattGLB ], col = "cyan")
    # points(temp[ Clearness_Kt > Clearness_Kt_THRES, Date ], temp[ Clearness_Kt > Clearness_Kt_THRES , wattGLB ], col = "yellow")

    points(temp[ GLB_ench     > GLB_ench_THRES     &
                     Clearness_Kt > Clearness_Kt_THRES &
                     wattGLB      > wattGLB_THRES      &
                     GLB_diff     > GLB_diff_THRES, Date ],
           temp[ GLB_ench     > GLB_ench_THRES     &
                     Clearness_Kt > Clearness_Kt_THRES &
                     wattGLB      > wattGLB_THRES      &
                     GLB_diff     > GLB_diff_THRES, wattGLB ], col = "red")

    title(main = as.Date(aday, origin = "1970-01-01"))
    legend("topleft", c("GHI","DNI",  "A-HAU", "TSI on horizontal level","GHI Enhancement event"),
           col = c("green",   "blue", "red", "black", "red"),
           pch = c(     NA,       NA,    NA,      NA,    1 ),
           lty = c(      1,        1,     1,       1,   NA ),
           bty = "n"
    )

    # plot(temp$Date, temp$Clearness_Kt)
    # abline(h=.8,col="red")

    # plot(temp$Date, temp$DiffuseFraction_Kd)
    # plot(temp$Date, temp$GLB_ench)
    # plot(temp$Date, temp$GLB_diff)

}



## keep only enhanced cases
Enh <- CSdt[ GLB_ench     > GLB_ench_THRES     &
                 Clearness_Kt > Clearness_Kt_THRES &
                 wattGLB      > wattGLB_THRES      &
                 GLB_diff     > GLB_diff_THRES    ]
```


We select a simple clear sky model for Thessaloniki, and use it to determine
cases of GHI enhancement based on a threshold of `r ampl` the modeled value.

There are `r length(unique(CSdt$Day))` days in the timeseries of GHI. Of which `r length(unique(Enh$Day))` have at least one
minute of enhanced GHI.


```{r }
##TODO get indexes of continues cases
##
## ## get time diffs
## coo <- diff(Enh$Date)
## ## get indexes of successive cases
## suc <- which(coo == 1)
## ## get the range of each sequence
## iv  <- seqToIntervals(suc)
##
## ## stats on each event
## Events <- data.frame( Start_date = apply(iv,1, function(x) { min( Enh$Date[ c( x[1]:(x[2]+1) ) ] ) } ),
##                       End_date   = apply(iv,1, function(x) { max( Enh$Date[ c( x[1]:(x[2]+1) ) ] ) } ),
##                       Duration   = apply(iv,1, function(x) { length( Enh$Date[ c( x[1]:(x[2]+1) ) ] ) } )
## )
##
## hist(Events$Duration, breaks = 100)
##
## ivv <- seqToIntervals(coo)
##
## coo[ivv[1,1]:ivv[1,2]]
##
## # gives the indices of the 'jumps'.
## which(diff(coo) != 1)

#
# hist(Enh$GLB_diff)
# hist(Enh$GLB_ench)


Enh_daily <- Enh[, .( N        = sum(!is.na(GLB_ench)),
                      N_ex     = sum( wattGLB > TSIextEARTH_comb * cosde(SZA)),
                      sum_Ench = sum( GLB_ench),
                      avg_Ench = mean(GLB_ench),
                      sd_Ench  = sd(GLB_ench),
                      sum_Diff = sum( GLB_diff)),
                 by = "Day"  ]

Enh_yearly <- Enh[, .( N        = sum(!is.na(GLB_ench)),
                       N_ex     = sum( wattGLB > TSIextEARTH_comb * cosde(SZA)),
                       sum_Ench = sum( GLB_ench),
                       avg_Ench = mean(GLB_ench),
                       sd_Ench  = sd(GLB_ench),
                       sum_Diff = sum( GLB_diff)),
                  by = year(Date)  ]

Enh_total <- Enh[, .( N        = sum(!is.na(GLB_ench)),
                       N_ex     = sum( wattGLB > TSIextEARTH_comb * cosde(SZA)),
                       sum_Ench = sum( GLB_ench),
                       avg_Ench = mean(GLB_ench),
                       sd_Ench  = sd(GLB_ench),
                       sum_Diff = sum( GLB_diff))   ]



Enh_sza    <- Enh[, .(N        = sum(!is.na(GLB_ench)),
                      N_ex     = sum( wattGLB > TSIextEARTH_comb * cosde(SZA)),
                      sum_Ench = sum( GLB_ench),
                      avg_Ench = mean(GLB_ench),
                      sd_Ench  = sd(GLB_ench),
                      sum_Diff = sum( GLB_diff)),
                  by = .(SZA     = (SZA - SZA_BIN / 2 ) %/% SZA_BIN) ]

CONF_INTERV <- .95
conf_param  <- 1-(1-CONF_INTERV)/2
suppressWarnings({
Enh_sza[,   Ench_EM:=qt(conf_param, df=N-1) * sd_Ench / sqrt(N)]
Enh_daily[, Ench_EM:=qt(conf_param, df=N-1) * sd_Ench / sqrt(N)]
Enh_yearly[,Ench_EM:=qt(conf_param, df=N-1) * sd_Ench / sqrt(N)]
Enh_total[, Ench_EM:=qt(conf_param, df=N-1) * sd_Ench / sqrt(N)]
})


# plot(Enh_daily$Day, Enh_daily$N)
# plot(Enh_daily$Day, Enh_daily$N_ex)
# plot(Enh_daily$Day, Enh_daily$sum_Ench)
# plot(Enh_daily$Day, Enh_daily$avg_Ench)
```

We will display some findings of our analysis.

The total number of cases we detect increase steadily the last decades.

```{r }
plot(Enh_yearly$year, Enh_yearly$N)

plot(Enh_yearly$year, Enh_yearly$N_ex)
```

Similar the sum of the energy (in 1 minute resolution), above the reference model, also increase.

```{r }
plot(  Enh_yearly$year, Enh_yearly$sum_Ench)
```

Although the mean difference in radiation per event seems to be almost
constant about $`r signif(Enh_total$avg_Ench,3)`\pm`r format(Enh_total$Ench_EM,scientific = T,digits = 2)`%$.

```{r }
# plot(Enh_daily$Day, Enh_daily$sum_Diff)
```

The number of case characterization is skewed by the SZA angle of the case, although this connection is indicative to the complexity of factor we have to take into account.

```{r }
plot(Enh_sza$SZA, Enh_sza$N)

plot(Enh_sza$SZA, Enh_sza$N_ex)
```

Interestingly, when we examine the total energy contribution by SZA we found a maximum at
$`r Enh_sza[ which.max(sum_Ench), SZA]`^\circ$.

```{r }
plot(Enh_sza$SZA, Enh_sza$sum_Ench)
# Enh_sza[ which.max(sum_Ench), SZA ]
```

And of course there is a dependency of the magnitude of the enhancement with the
SZA.

```{r }
ylim <- range(Enh_sza$avg_Ench - Enh_sza$Ench_EM, Enh_sza$avg_Ench + Enh_sza$Ench_EM, na.rm = T)
plot(  Enh_sza$SZA, Enh_sza$avg_Ench, pch = 19, cex = 0.7, ylim = ylim)
arrows(Enh_sza$SZA, Enh_sza$avg_Ench - Enh_sza$Ench_EM, Enh_sza$SZA, Enh_sza$avg_Ench + Enh_sza$Ench_EM, length=0.03, angle=90, code=3)
```


Some aspects we have to study is the seasonality of the above finds
remove the sza dependence in order to see some local phenomena of the site



**END**

```{r include=T, echo=F}
tac <- Sys.time()
cat(sprintf("\n%s %s@%s %s %f mins\n\n\n",Sys.time(),Sys.info()["login"],Sys.info()["nodename"],Script.Name,difftime(tac,tic,units="mins")))
```

